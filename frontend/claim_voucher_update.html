<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>个人中心</title>
    <meta name="keywords" content="HTML5 Bootstrap 3 Admin Template UI Theme" />
    <meta name="description" content="AbsoluteAdmin - A Responsive HTML5 Admin UI Framework">
    <meta name="author" content="AbsoluteAdmin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/theme.css">
    <link rel="stylesheet" type="text/css" href="css/admin-forms.css">
    <link rel="shortcut icon" href="img/favicon.ico">
</head>

<body class="admin-validation-page" data-spy="scroll" data-target="#nav-spy" data-offset="200">
    <div id="main">
        <header class="navbar navbar-fixed-top navbar-shadow">
            <div class="navbar-branding">
                <a class="navbar-brand" href="#">
                    <b>EasyOffice</b>OA
                </a>
                <span id="toggle_sidemenu_l" class="ad ad-lines"></span>
            </div>
            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown menu-merge">
                    <a href="#" class="dropdown-toggle fw600 p15" data-toggle="dropdown">
                        <img src="./img/avatars/5.jpg" alt="avatar" class="mw30 br64">
                        <span id="rname" class="hidden-xs pl15"> </span>
                        <span class="caret caret-tp hidden-xs"></span>
                    </a>
                    <ul class="dropdown-menu list-group dropdown-persist w250" role="menu">
                        <li class="list-group-item">
                            <a href="./self.html" class="animated animated-short fadeInUp">
                                <span class="fa fa-user"></span> 个人信息
                                <span class="label label-warning"></span>
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="./change_password.html" id="setPaswd" class="animated animated-short fadeInUp">
                                <span class="fa fa-gear"></span> 设置密码 </a>
                        </li>
                        <li class="dropdown-footer">
                            <a href="#" onclick="quit()" class="">
                                <span class="fa fa-power-off pr5"></span> 退出 </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </header>
        <aside id="sidebar_left" class="nano nano-light affix">
            <div class="sidebar-left-content nano-content">
                <header class="sidebar-header">
                    <div class="sidebar-widget author-widget">
                        <div class="media">
                            <a class="media-left" href="#">
                                <img src="./img/avatars/5.jpg" class="img-responsive">
                            </a>
                            <div class="media-body">
                                <div class="media-author">
                                    <span id="lname"></span>
                                    --
                                    <span id="post1"></span>
                                </div>
                                <div class="media-links">
                                    <a href="#" onclick="quit()">退出</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-widget search-widget hidden">
                        <div class="input-group">
                            <span class="input-group-addon">
                                <i class="fa fa-search"></i>
                            </span>
                            <input type="text" id="sidebar-search" class="form-control" placeholder="Search...">
                        </div>
                    </div>
                </header>
                <ul class="nav sidebar-menu">
                    <li class="sidebar-label pt20">日常管理</li>
                    <li>
                        <a href="./claim_voucher_deal.html">
                            <span class="glyphicon glyphicon-book"></span>
                            <span class="sidebar-title">待处理报销单</span>
                            <span class="sidebar-title-tray">
                                <span class="label label-xs bg-primary">New</span>
                            </span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="./claim_voucher_self.html">
                            <span class="glyphicon glyphicon-home"></span>
                            <span class="sidebar-title">个人报销单</span>
                        </a>
                    </li>
                    <li>
                        <a href="./claim_voucher_add.html">
                            <span class="fa fa-calendar"></span>
                            <span class="sidebar-title">填写报销单</span>
                        </a>
                    </li>
                    <li id="infoManagmentLabel" class="sidebar-label pt15">基础信息管理</li>
                    <li id="employeeManagement">
                        <a class="accordion-toggle" href="#">
                            <span class="glyphicon glyphicon-check"></span>
                            <span class="sidebar-title hid">员工管理</span>
                            <span class="caret"></span>
                        </a>
                        <ul class="nav sub-nav">
                            <li>
                                <a href="#" id="allEmployee">
                                    <span class="glyphicon glyphicon-calendar"></span> 所有员工 </a>
                            </li>
                            <li class="active">
                                <a href="#" id="addEmployee">
                                    <span class="glyphicon glyphicon-check"></span> 添加员工 </a>
                            </li>
                        </ul>
                    </li>
                    <li id="departmentManagement">
                        <a class="accordion-toggle" href="#">
                            <span class="fa fa-columns"></span>
                            <span class="sidebar-title">部门管理</span>
                            <span class="caret"></span>
                        </a>
                        <ul class="nav sub-nav">
                            <li>
                                <a href="#" id="allDepartment">
                                    <span class="glyphicon glyphicon-calendar"></span> 所有部门 </a>
                            </li>
                            <li class="active">
                                <a href="#" id="addDepartment">
                                    <span class="glyphicon glyphicon-check"></span> 添加部门 </a>
                            </li>
                        </ul>
                    </li>
                </ul>
                <div class="sidebar-toggle-mini">
                    <a href="#">
                        <span class="fa fa-sign-out"></span>
                    </a>
                </div>
            </div>
        </aside>
        <section id="content_wrapper">
            <section id="content" class="table-layout animated fadeIn">
                <div class="tray tray-center">
                    <div class="content-header">
                        <h2> 修改报销单 </h2>
                        <p class="lead"></p>
                    </div>
                    <div class="admin-form theme-primary mw1000 center-block" style="padding-bottom: 175px;">
                        <div class="panel heading-border">
                            <form id="admin-form" name="addForm" action="#">
                                <div class="panel-body bg-light">
                                    <div class="section-divider mt20 mb40">
                                        <span> 基本信息 </span>
                                    </div>
                                    <div class="section">
                                        <label for="claimVoucher.cause" class="field prepend-icon">
                                            <input path="claimVoucher.cause" class="gui-input" placeholder="事由..." id="cause"/>
                                            <label for="claimVoucher.cause" class="field-icon">
                                                <i class="fa fa-lock"></i>
                                            </label>
                                        </label>
                                    </div>
                                    <div class="section-divider mt20 mb40">
                                        <span> 费用明细 </span>
                                    </div>
                                    <div class="section row" id="items">
                                        
                                    </div>
                                    <div class="section row">
                                        <div class="col-md-3">
                                            <label for="totalMoney" class="field prepend-icon">
                                                <input type="text" id="totalMoney" class="gui-input" placeholder="总金额..." readonly="true" >
                                                <label for="totalMoney" class="field-icon">
                                                    <i class="fa fa-user"></i>
                                                </label>
                                            </label>
                                        </div>
                                        <div class="section" style="text-align:right;">
                                            <div class="col-md-9">
                                                <button type="button" class="button" id="addItemButton"> + </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-footer text-right">
                                        <button type="submit" class="button" id="save"> 保存 </button>
                                        <button type="button" class="button" onclick="javascript:window.history.go(-1);"> 返回
                                        </button>
                                    </div>
                                </div>
                            </form:form>
                        </div>
                    </div>
                </div>
            </section>
        </section>
    </div>

    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/jquery.validate.min.js"></script>
    <script src="js/additional-methods.min.js"></script>
    <script src="js/jquery-ui-datepicker.min.js"></script>
    <script src="js/utility.js"></script>
    <script src="js/demo.js"></script>
    <script src="js/main.js"></script>
    <script type="text/javascript" src="js/pages.js"></script>
    <script src="js/base.js"></script>
    <!-- <script src="js/nav-base.js"></script> -->

    <script>
        $(document).ready(function (){
            if(!sessionStorage.getItem('sn')){
                alert("请先登录")
                location.href = 'login.html'
            }
            if(sessionStorage.post != '总经理'){
                $('#departmentManagement').addClass("hidden")
                if(sessionStorage.post != '部门经理'){
                    $('#employeeManagement').addClass("hidden")
                    $('#infoManagmentLabel').addClass("hidden")
                }
            }
            $('#rname').html(sessionStorage.getItem("name"))
            $('#lname').html(sessionStorage.getItem("name"))
            $('#post1').html(sessionStorage.getItem("post"))
            var id = getQueryVariable("id")
            $.ajax({
                method:'POST',
                url:'http://127.0.0.1:5050/expense/detail',
                xhrFields:{withCredentials:true},
                data:`id=${id}`,
                success:function(data,msg,xhr){
                    let cause = data.info.cause
                    let total_amount = data.info.total_amount
                    let itemslen = data.detail.length
                    let htm = ''
                    $('#cause').val(cause)
                    $("#totalMoney").val(total_amount)
                    for(var i=0;i<itemslen;i++){
                        htm +=  '<div>\
                                    <div class="col-md-3">\
                                        <label for="items['+i+'].item" class="field prepend-icon">\
                                            <select name="setPo" id="item" class="gui-input">\
                                                <option value="1" selected disabled style="display: none;">--花销类型--</option>\
                                                <option value="餐饮">餐饮</option>\
                                                <option value="住宿">住宿</option>\
                                                <option value="交通">交通</option>\
                                                <option value="办公">办公</option>\
                                                <option value="会议">会议</option>\
                                            </select>\
                                        </label>\
                                    </div>\
                                    <div class="col-md-3">\
                                        <label for="items['+i+'].amount" class="field prepend-icon">\
                                            <input type="text" class="gui-input money" placeholder="金额...">\
                                            <label for="items['+i+'].amount" class="field-icon">\
                                                <i class="fa fa-lock"></i>\
                                            </label>\
                                        </label>\
                                    </div>\
                                    <div class="col-md-5">\
                                        <label for="items['+i+'].comment" class="field prepend-icon">\
                                            <input type="text" class="gui-input" placeholder="备注..." >\
                                            <label for="items['+i+'].comment" class="field-icon">\
                                                <i class="fa fa-lock"></i>\
                                            </label>\
                                        </label>\
                                    </div>\
                                    <div class="col-md-1" style="text-align:right;">\
                                        <button type="button" class="button btn-primary"> X </button>\
                                    </div>\
                                </div>'
                    }
                    $("#items").html(htm)
                    for(var i=0;i<itemslen;i++){
                        $("#items").children("div").eq(i).children().eq(0).find("select").val(data.detail[i].item)
                        $("#items").children("div").eq(i).children().eq(1).find("input").val(data.detail[i].amount)
                        $("#items").children("div").eq(i).children().eq(2).find("input").val(data.detail[i].comment)
                    }
                    builderIndex();
	                calculateMoney();
                    setClick();
                },
                error:function(xhr,err){
                    console.log('异步请求失败'),
                    console.log(xhr)
                    console.log(err)
                }
            })
        })

        $('#save').click(function (){
            var id = getQueryVariable("id")
            let len = $('#items').children().length
            let cause = $('#cause').val()
            if(cause==''){
                $('#modelMsgTitle').html("创建失败")
                $('#modelMsgBody').html("事由不能为空")
                $('#modelMsg').modal()
            }
            else{
                let nullJudge = false
                let items = []
                let total_amount = $('#totalMoney').val()
                for(var i=0;i<len; i++){
                    let item = $("#items").children("div").eq(i).children().eq(0).find("select").val()
                    let amount = $("#items").children("div").eq(i).children().eq(1).find("input").val()
                    let comment = $("#items").children("div").eq(i).children().eq(2).find("input").val()
                    let temp = new Array()
                    temp.push(item)
                    temp.push(amount)
                    temp.push(comment)
                    items.push(temp)
                    if(item==null || amount==''){
                        nullJudge = true
                        break
                    }
                }
                if(nullJudge){
                    $('#modelMsgTitle').html("创建失败")
                    $('#modelMsgBody').html("明细类型或金额不能为空")
                    $('#modelMsg').modal()
                }
                else{
                    var formData = {
                        "id":id,
                        "cause":cause,
                        "items":items,
                        "total_amount":total_amount
                    }
                    $.ajax({
                        method:'POST',
                        url:'http://127.0.0.1:5050/expense/update',
                        data:`formData=${JSON.stringify(formData)}`,
                        xhrFields:{withCredentials:true},
                        success:function(data,msg,xhr){
                            if(data.code==200){
                                //alert("保存成功")
                                window.location.href = "claim_voucher_self.html"
                            }
                            else{
                                $('#modelMsgTitle').html("保存失败")
                                $('#modelMsgBody').html(data.msg)
                                $('#modelMsg').modal()
                            }
                        },
                        error:function(xhr,err){
                            console.log('异步请求失败'),
                            console.log(xhr)
                            console.log(err)
                        }
                    })
                }
            }
        })
        function setClick(){
            $("#addItemButton").click(
                function(){
                    $("#items").children("div").last().after($("#items").children("div").first().clone());
                    $("#items").children("div").find("button").click(
                        function(){
                            $(this).parent().parent().remove();
                            if($("#items").children("div").size()==1){
                                $("#items").find("button").attr("disabled",true);
                            }
                            builderIndex();
                            calculateMoney();
                        }
                    );
                    $("#items").find("button").attr("disabled",false);
                    builderIndex();	
                    $(".money").change(
                        function(){
                            calculateMoney();
                        }
                    );
                    calculateMoney();
                }
            );
            $(".money").change(
                function(){
                    calculateMoney();
                }
            );
        }

        function builderIndex(){
            $.each($("#items").children(),function(i,val){
                $("#items").children("div").eq(i).children().eq(0).find("select").attr("name","items["+i+"].item");		
                $("#items").children("div").eq(i).children().eq(1).find("input").attr("name","items["+i+"].amount");				
                $("#items").children("div").eq(i).children().eq(2).find("input").attr("name","items["+i+"].comment");
                        
            });	
        }

        function calculateMoney(){
            var totalMoney=0;
            $.each($(".money"),function(i,val){
                totalMoney+=parseFloat($(".money").eq(i).val());
            });
            $("#totalMoney").val(totalMoney)
        }
    </script>
    <div id="modelMsg" class="modal fade"><!--半透明遮罩-->
        <div class="modal-dialog modal-sm"><!--对话框的尺寸，位置-->
            <div class="modal-content"><!--边框，倒角，背景色-->
                <!--头部-->
                <div class="modal-header">
                    <h4 class="modal-title" id="modelMsgTitle"></h4>
                </div>
                <!--主体-->
                <div class="modal-body">
                    <p>
                        <span id="modelMsgBody"></span>
                    </p>
                </div>
                <!--尾部-->
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="btn btn-info">确定</button>
            </div>
        </div>
    </div>
</body>

</html>